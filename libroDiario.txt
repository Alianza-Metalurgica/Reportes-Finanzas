-- Cubo Diario
Select LIB, AÑO, MES, CUENTA, DENOMINACION, FECHA_OPER, NRO_CORRELAT, DOC_SUSTENTATORIO, GLOSA, DEBE, HABER, BATCH, MONEDA, ASENTADO, TIPO, TYPE 
  From DW_PERU_FORMATO_5_1 R
 Where R.MONEDA = 'SOL'
   And R.AÑO = '2014'
   And R.MES = '07'
   
-- Libro Diaro
Select LIB, AÑO, MES, CUENTA, DENOMINACION, FECHA_OPER, NRO_CORRELAT, DOC_SUSTENTATORIO, GLOSA, DEBE, HABER, BATCH, MONEDA, ASENTADO, TIPO, TYPE
  From DW_PERU_FORMATO_5_1 R
 Where R.MONEDA = 'SOL'
   And R.AÑO = '2014' And R.MES = '07'
   
-- Libro Diario Visual
SELECT TXT FROM LE_PERU_FORMATO_5_1 WHERE AÑO = '2014' AND MES = '07'

SP_HELPTEXT LE_PERU_FORMATO_5_1

CREATE VIEW LE_PERU_FORMATO_5_1
AS
SELECT --TOP 10
AÑO,MES,
CAST(AÑO AS  VARCHAR(4)) + RIGHT(REPLICATE('0',2)+CAST(MES AS VARCHAR(2)),2)+'00'
+'|' +
NRO_CORRELAT 
+'|' +
'M'+SUB_CODIGO
+'|' +
'01'
+'|' +
CUENTA
+'|' +
RIGHT(REPLICATE('0',2)+CAST(DATEPART(DD,FECHA_OPER) AS VARCHAR(2)),2)+'/'+RIGHT(REPLICATE('0',2)+CAST(DATEPART(MM,FECHA_OPER ) AS VARCHAR(2)),2)+'/'+CAST(DATEPART(YY,FECHA_OPER ) AS VARCHAR(4))
+'|' +
LEFT(GLOSA,100)
+'|' +
CAST (DEBE AS VARCHAR(14))
+'|' +
CAST (HABER AS VARCHAR(14))
+'|' +
''
+'|' +
''
+'|' +
''
+'|' +
'1'
+'|' 
AS TXT
FROM DW_PERU_FORMATO_5_1_TXT
WHERE MONEDA='SOL'
AND (DEBE<>0 OR HABER<>0)
--AND TYPE IN ('GJ')
AND AÑO=2014 AND MES=7
--AND FECHA_OPER BETWEEN '20130801' AND '20130805'

SP_HELPTEXT DW_PERU_FORMATO_5_1_TXT

SELECT   
'14' AS LIB,  
--,APTC.DESCRIPCION_IVA AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
RD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
RD.POSTING_DATE AS FECHA_OPER,  
RD.INVOICE_ID AS NRO_CORRELAT,   
'M'+RIGHT(REPLICATE('0',2)+CAST(RD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(RD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO,
RD.INVOICE_ID AS DOC_SUSTENTATORIO,  
'ARI ' + LEFT((RD.INVOICE_ID + SPACE(15)),15) + LEFT(( C.ID + SPACE(15)),15) + '  ' + C.NAME AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN 
(SUM(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
RD.BATCH_ID AS BATCH,  
RD.CURRENCY_ID AS MONEDA,  
RD.ENTITY_ID AS ENTIDAD,  
RD.POSTING_STATUS AS ASENTADO,  
'01. ARI - Registro de Facturas CxC' AS TIPO  
,'ARI' AS TYPE  
,RD.INVOICE_ID AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,C.ID AS CODIGO_CLIPROV  
,C.NAME AS RAZON_SOCIAL_CLIPROV  
FROM RECEIVABLE_DIST RD  
INNER JOIN RECEIVABLE R ON RD.INVOICE_ID=R.INVOICE_ID  
INNER JOIN CUSTOMER C ON R.CUSTOMER_ID=C.ID  
INNER JOIN ACCOUNT A ON A.ID=RD.GL_ACCOUNT_ID  
INNER JOIN ARG_TIPO_CC ATC ON R.INVOICE_ID=ATC.INVOICE_ID  
INNER JOIN ARG_PARAM_TIPO_CC APTC ON APTC.TIPO=ATC.TIPO  
INNER JOIN ACCOUNT_PERIOD AP ON RD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON R.ENTITY_ID=AG.MFG_ENTITY_ID
WHERE AP.ACCT_YEAR = '2014'
  AND AP.ACCT_PERIOD = '07'
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,RD.GL_ACCOUNT_ID,A.DESCRIPTION,RD.POSTING_DATE,RD.INVOICE_ID,C.ID,C.NAME 
,RD.BATCH_ID,RD.CURRENCY_ID,RD.ENTITY_ID,RD.POSTING_STATUS
,RD.DIST_NO

--------------------------------
SELECT   
'14' AS LIB,  
--,APTC.DESCRIPCION_IVA AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
RD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
RD.POSTING_DATE AS FECHA_OPER,  
RD.INVOICE_ID AS NRO_CORRELAT,   
'M'+RIGHT(REPLICATE('0',2)+CAST(RD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(RD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO,
RD.INVOICE_ID AS DOC_SUSTENTATORIO,  
'ARI ' + LEFT((RD.INVOICE_ID + SPACE(15)),15) + LEFT(( C.ID + SPACE(15)),15) + '  ' + C.NAME AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN 
(SUM(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RD.AMOUNT_TYPE='CR' AND RD.AMOUNT > 0 THEN RD.AMOUNT ELSE   
(CASE WHEN RD.AMOUNT_TYPE='DR' AND RD.AMOUNT < 0 THEN RD.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
RD.BATCH_ID AS BATCH,  
RD.CURRENCY_ID AS MONEDA,  
RD.ENTITY_ID AS ENTIDAD,  
RD.POSTING_STATUS AS ASENTADO,  
'01. ARI - Registro de Facturas CxC' AS TIPO  
,'ARI' AS TYPE  
,RD.INVOICE_ID AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,C.ID AS CODIGO_CLIPROV  
,C.NAME AS RAZON_SOCIAL_CLIPROV  
FROM RECEIVABLE_DIST RD  
INNER JOIN RECEIVABLE R ON RD.INVOICE_ID=R.INVOICE_ID  
INNER JOIN CUSTOMER C ON R.CUSTOMER_ID=C.ID  
INNER JOIN ACCOUNT A ON A.ID=RD.GL_ACCOUNT_ID  
INNER JOIN ARG_TIPO_CC ATC ON R.INVOICE_ID=ATC.INVOICE_ID  
INNER JOIN ARG_PARAM_TIPO_CC APTC ON APTC.TIPO=ATC.TIPO  
INNER JOIN ACCOUNT_PERIOD AP ON RD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON R.ENTITY_ID=AG.MFG_ENTITY_ID  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,RD.GL_ACCOUNT_ID,A.DESCRIPTION,RD.POSTING_DATE,RD.INVOICE_ID,C.ID,C.NAME 
,RD.BATCH_ID,RD.CURRENCY_ID,RD.ENTITY_ID,RD.POSTING_STATUS
,RD.DIST_NO
UNION ALL  
--API--    
SELECT   
'08' AS LIB,  
--APTC.DESCRIPCION_IVA AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
PD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
PD.POSTING_DATE AS FECHA_OPER,  
PD.VOUCHER_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(PD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(PD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,P.INVOICE_ID AS DOC_SUSTENTATORIO,  
'API ' + LEFT((P.INVOICE_ID + SPACE(15)),15) + LEFT(( V.ID + SPACE(15)),15) + '  ' + V.NAME AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN PD.AMOUNT_TYPE='DR' AND PD.AMOUNT > 0 THEN PD.AMOUNT ELSE   
(CASE WHEN PD.AMOUNT_TYPE='CR' AND PD.AMOUNT < 0 THEN PD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN PD.AMOUNT_TYPE='CR' AND PD.AMOUNT > 0 THEN PD.AMOUNT ELSE   
(CASE WHEN PD.AMOUNT_TYPE='DR' AND PD.AMOUNT < 0 THEN PD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN PD.AMOUNT_TYPE='DR' AND PD.AMOUNT > 0 THEN PD.AMOUNT ELSE   
(CASE WHEN PD.AMOUNT_TYPE='CR' AND PD.AMOUNT < 0 THEN PD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN PD.AMOUNT_TYPE='CR' AND PD.AMOUNT > 0 THEN PD.AMOUNT ELSE   
(CASE WHEN PD.AMOUNT_TYPE='DR' AND PD.AMOUNT < 0 THEN PD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN PD.AMOUNT_TYPE='DR' AND PD.AMOUNT > 0 THEN PD.AMOUNT ELSE   
(CASE WHEN PD.AMOUNT_TYPE='CR' AND PD.AMOUNT < 0 THEN PD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN PD.AMOUNT_TYPE='CR' AND PD.AMOUNT > 0 THEN PD.AMOUNT ELSE   
(CASE WHEN PD.AMOUNT_TYPE='DR' AND PD.AMOUNT < 0 THEN PD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN 
(SUM(CASE WHEN PD.AMOUNT_TYPE='DR' AND PD.AMOUNT > 0 THEN PD.AMOUNT ELSE   
(CASE WHEN PD.AMOUNT_TYPE='CR' AND PD.AMOUNT < 0 THEN PD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN PD.AMOUNT_TYPE='CR' AND PD.AMOUNT > 0 THEN PD.AMOUNT ELSE   
(CASE WHEN PD.AMOUNT_TYPE='DR' AND PD.AMOUNT < 0 THEN PD.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
PD.BATCH_ID AS BATCH,  
PD.CURRENCY_ID AS MONEDA,  
PD.ENTITY_ID AS ENTIDAD,  
PD.POSTING_STATUS AS ASENTADO  
,'02. API - Registro de Facturas CxP' AS TIPO  
,'API' AS TYPE  
,NULL AS INVOICE_ID  
,PD.VOUCHER_ID AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,V.ID AS CODIGO_CLIPROV  
,V.NAME AS RAZON_SOCIAL_CLIPROV  
FROM PAYABLE_DIST PD  
INNER JOIN PAYABLE P ON PD.VOUCHER_ID=P.VOUCHER_ID  
INNER JOIN VENDOR V ON V.ID=P.VENDOR_ID  
INNER JOIN ACCOUNT A ON A.ID=PD.GL_ACCOUNT_ID  
INNER JOIN ARG_TIPO_CP ATC ON P.VOUCHER_ID=ATC.VOUCHER_ID  
INNER JOIN ARG_PARAM_TIPO_CP APTC ON APTC.TIPO=ATC.TIPO  
INNER JOIN ACCOUNT_PERIOD AP ON PD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON P.ENTITY_ID=AG.MFG_ENTITY_ID  
WHERE APTC.TIPO NOT IN (SELECT PAYB_TIPO_CREDIT_LETTER FROM ARG_APPLICATIONGBL )  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION,PD.GL_ACCOUNT_ID,A.DESCRIPTION  
,PD.POSTING_DATE,PD.VOUCHER_ID,P.INVOICE_ID,V.ID,V.NAME,PD.BATCH_ID,PD.CURRENCY_ID,PD.ENTITY_ID,PD.POSTING_STATUS  
,PD.DIST_NO  
UNION ALL
--ARC--  
SELECT 
CASE WHEN CR.BANK_ACCOUNT_ID=AG1.BANK_ACCOUNT_ID_CC_LETTER THEN '05' ELSE '01' END AS LIB,  
--APTC.DESCRIPCION_IVA AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
CRD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
CRD.POSTING_DATE AS FECHA_OPER,  
CR.CUSTOMER_ID + ' - ' + CRD.CHECK_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(CRD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(CRD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,CASE WHEN CR.BANK_ACCOUNT_ID=AG1.BANK_ACCOUNT_ID_CC_LETTER THEN CR.DEPOSIT_ID ELSE CRD.CHECK_ID END AS DOC_SUSTENTATORIO,  
'ARC ' + LEFT(((CASE WHEN CR.BANK_ACCOUNT_ID=AG1.BANK_ACCOUNT_ID_CC_LETTER THEN CR.DEPOSIT_ID ELSE CRD.CHECK_ID END) + SPACE(15)),15) + LEFT(( C.ID + SPACE(15)),15) + '  ' + C.NAME AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN CRD.AMOUNT_TYPE='DR' AND CRD.AMOUNT > 0 THEN CRD.AMOUNT ELSE   
(CASE WHEN CRD.AMOUNT_TYPE='CR' AND CRD.AMOUNT < 0 THEN CRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN CRD.AMOUNT_TYPE='CR' AND CRD.AMOUNT > 0 THEN CRD.AMOUNT ELSE   
(CASE WHEN CRD.AMOUNT_TYPE='DR' AND CRD.AMOUNT < 0 THEN CRD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN CRD.AMOUNT_TYPE='DR' AND CRD.AMOUNT > 0 THEN CRD.AMOUNT ELSE   
(CASE WHEN CRD.AMOUNT_TYPE='CR' AND CRD.AMOUNT < 0 THEN CRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN CRD.AMOUNT_TYPE='CR' AND CRD.AMOUNT > 0 THEN CRD.AMOUNT ELSE   
(CASE WHEN CRD.AMOUNT_TYPE='DR' AND CRD.AMOUNT < 0 THEN CRD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN CRD.AMOUNT_TYPE='DR' AND CRD.AMOUNT > 0 THEN CRD.AMOUNT ELSE   
(CASE WHEN CRD.AMOUNT_TYPE='CR' AND CRD.AMOUNT < 0 THEN CRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN CRD.AMOUNT_TYPE='CR' AND CRD.AMOUNT > 0 THEN CRD.AMOUNT ELSE   
(CASE WHEN CRD.AMOUNT_TYPE='DR' AND CRD.AMOUNT < 0 THEN CRD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN
(SUM(CASE WHEN CRD.AMOUNT_TYPE='DR' AND CRD.AMOUNT > 0 THEN CRD.AMOUNT ELSE   
(CASE WHEN CRD.AMOUNT_TYPE='CR' AND CRD.AMOUNT < 0 THEN CRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN CRD.AMOUNT_TYPE='CR' AND CRD.AMOUNT > 0 THEN CRD.AMOUNT ELSE   
(CASE WHEN CRD.AMOUNT_TYPE='DR' AND CRD.AMOUNT < 0 THEN CRD.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
CRD.BATCH_ID AS BATCH,  
CRD.CURRENCY_ID AS MONEDA,  
CRD.ENTITY_ID AS ENTIDAD,  
CRD.POSTING_STATUS AS ASENTADO  
,'03. ARC - Cobranzas' AS TIPO  
,'ARC' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,CRD.CUSTOMER_ID AS CUSTOMER_ID  
,CRD.CHECK_ID AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,C.ID AS CODIGO_CLIPROV  
,C.NAME AS RAZON_SOCIAL_CLIPROV  
FROM CASH_RECEIPT_DIST CRD  
INNER JOIN CASH_RECEIPT CR ON CRD.CUSTOMER_ID=CR.CUSTOMER_ID AND CRD.CHECK_ID=CR.CHECK_ID  
INNER JOIN ARG_COBRANZAS AC ON AC.CUSTOMER_ID=CR.CUSTOMER_ID AND AC.NRO_RECIBO=CR.CHECK_ID AND CR.BANK_ACCOUNT_ID =AC.COD_RECIBO_BANCO 
INNER JOIN CUSTOMER C ON CR.CUSTOMER_ID=C.ID   
INNER JOIN ACCOUNT A ON CRD.GL_ACCOUNT_ID=A.ID  
INNER JOIN ARG_PARAM_TIPO_CC APTC ON APTC.TIPO=AC.TIPO  
INNER JOIN ACCOUNT_PERIOD AP ON CRD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON CR.ENTITY_ID=AG.MFG_ENTITY_ID  
INNER JOIN ARG_APPLICATIONGBL AG1 ON AG.ID=AG1.ID  
GROUP BY CR.BANK_ACCOUNT_ID,AG1.BANK_ACCOUNT_ID_CC_LETTER  
,AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION,CRD.GL_ACCOUNT_ID,A.DESCRIPTION  
,CRD.POSTING_DATE,CR.CUSTOMER_ID ,CRD.CHECK_ID,CR.DEPOSIT_ID,C.ID,C.NAME  
,CRD.BATCH_ID,CRD.CURRENCY_ID,CRD.ENTITY_ID,CRD.POSTING_STATUS,CRD.CUSTOMER_ID   
,CRD.DIST_NO 
UNION ALL  
--APC--  
 SELECT   
CASE WHEN CD.BANK_ACCOUNT_ID=AG1.PAYB_BANK_ACCOUNT_ID_LETTER THEN '05' ELSE '01' END AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
CDD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
CDD.POSTING_DATE AS FECHA_OPER,  
CD.BANK_ACCOUNT_ID + ' - ' + CAST(CD.CONTROL_NO AS VARCHAR (15)) AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(CDD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(CDD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,(CASE WHEN CD.BANK_ACCOUNT_ID=AG1.PAYB_BANK_ACCOUNT_ID_LETTER THEN APA.ID  
WHEN CHQ.TIPO_CAB='P' AND CHQ.TELECREDITO_CAB='Y' THEN 'PM: ' + CHQ.CHECK_ID  
WHEN CHQ.TIPO_DET='B' AND CHQ.TELECREDITO_DET='Y' THEN 'CHQ: ' + ISNULL(CHQ.CHECK_ID,'S/N')  
ELSE CAST(CD.CONTROL_NO AS VARCHAR (15)) END) AS DOC_SUSTENTATORIO,  
'APC ' + LEFT(((  
CASE WHEN CD.BANK_ACCOUNT_ID=AG1.PAYB_BANK_ACCOUNT_ID_LETTER AND APA.ID IS NOT NULL THEN APA.ID  
WHEN CHQ.TIPO_CAB='P' AND CHQ.TELECREDITO_CAB='Y' THEN 'PM: ' + ISNULL(CHQ.CHECK_ID,'S/N')  
WHEN CHQ.TIPO_DET='B' AND CHQ.TELECREDITO_DET='Y' THEN 'CHQ: ' + ISNULL(CHQ.CHECK_ID,'S/N')  
ELSE CAST(CD.CONTROL_NO AS VARCHAR (15)) END  
) + SPACE(15)),15) +   
(CASE WHEN V.ID IS NULL THEN CD.NAME ELSE LEFT(( V.ID + SPACE(15)),15) + '  ' + CD.NAME END) AS GLOSA,  
ISNULL(CHQ.DESCRIPCION_OPER,EFE.DESCRIPCION_OPER) AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN 
(SUM(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
CDD.BATCH_ID AS BATCH,  
CDD.CURRENCY_ID AS MONEDA,  
CDD.ENTITY_ID AS ENTIDAD,  
CDD.POSTING_STATUS AS ASENTADO  
,'04. APC - Pagos' AS TIPO  
,'APC' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,CDD.BANK_ACCOUNT_ID AS BANK_ACCOUNT_ID  
,CDD.CONTROL_NO AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,V.ID AS CODIGO_CLIPROV  
,V.NAME AS RAZON_SOCIAL_CLIPROV  
FROM CASH_DISBURSE_DIST CDD  
INNER JOIN CASH_DISBURSEMENT CD ON CDD.BANK_ACCOUNT_ID = CD.BANK_ACCOUNT_ID AND CDD.CONTROL_NO = CD.CONTROL_NO  
INNER JOIN  ACCOUNT A ON A.ID = CDD.GL_ACCOUNT_ID  
INNER JOIN ACCOUNT_PERIOD AP ON CDD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON CD.ENTITY_ID=AG.MFG_ENTITY_ID  
INNER JOIN ARG_APPLICATIONGBL AG1 ON AG.ID=AG1.ID  
LEFT OUTER JOIN VENDOR V ON V.ID=CD.VENDOR_ID  
LEFT OUTER JOIN (  
SELECT AOP.OP_BANK_ACCOUNT_ID,AOP.OP_CONTROL_NO,AOP.BANK_ACCOUNT_ID,AOP.CONTROL_NO,AOP.CHECK_ID  
,CD.MEMO AS DESCRIPCION_OPER  
,ATAB1.TIPO AS TIPO_DET,ATAB1.TELECREDITO AS TELECREDITO_DET  
,ATAB2.TIPO AS TIPO_CAB,ATAB2.TELECREDITO AS TELECREDITO_CAB  
FROM ARG_ORDEN_PAGO AOP  
INNER JOIN ARG_TIPO_ASOC_BANC ATAB1 ON AOP.BANK_ACCOUNT_ID=ATAB1.COD_BANCO AND ATAB1.TIPO IN ('B')  
INNER JOIN CASH_DISBURSEMENT CD ON CD.BANK_ACCOUNT_ID=AOP.BANK_ACCOUNT_ID  AND CD.CONTROL_NO=AOP.CONTROL_NO  
INNER JOIN ARG_TIPO_ASOC_BANC ATAB2 ON AOP.OP_BANK_ACCOUNT_ID=ATAB2.COD_BANCO AND ATAB2.TIPO IN ('P')  
) CHQ ON CHQ.OP_CONTROL_NO=CD.CONTROL_NO AND CHQ.OP_BANK_ACCOUNT_ID=CD.BANK_ACCOUNT_ID-- WHERE OP_CONTROL_NO=241 AND OP_BANK_ACCOUNT_ID='P'  
LEFT OUTER JOIN ARG_PAYB_APPLICATION APA ON APA.CONTROL_NO=CD.CONTROL_NO AND CD.BANK_ACCOUNT_ID=APA.BANK_ACCOUNT_ID  
LEFT OUTER JOIN (  
SELECT AOP.OP_BANK_ACCOUNT_ID,AOP.OP_CONTROL_NO,AOP.BANK_ACCOUNT_ID,AOP.CONTROL_NO,AOP.CHECK_ID  
,CD.MEMO AS DESCRIPCION_OPER  
,ATAB1.TIPO AS TIPO_DET,ATAB1.TELECREDITO AS TELECREDITO_DET  
,ATAB2.TIPO AS TIPO_CAB,ATAB2.TELECREDITO AS TELECREDITO_CAB  
FROM ARG_ORDEN_PAGO AOP  
INNER JOIN ARG_TIPO_ASOC_BANC ATAB1 ON AOP.BANK_ACCOUNT_ID=ATAB1.COD_BANCO AND ATAB1.TIPO IN ('E')  
INNER JOIN CASH_DISBURSEMENT CD ON CD.BANK_ACCOUNT_ID=AOP.BANK_ACCOUNT_ID  AND CD.CONTROL_NO=AOP.CONTROL_NO  
INNER JOIN ARG_TIPO_ASOC_BANC ATAB2 ON AOP.OP_BANK_ACCOUNT_ID=ATAB2.COD_BANCO AND ATAB2.TIPO IN ('P')  
) EFE ON EFE.OP_CONTROL_NO=CD.CONTROL_NO AND EFE.OP_BANK_ACCOUNT_ID=CD.BANK_ACCOUNT_ID  
WHERE   
(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END) <>  
(CASE WHEN CDD.AMOUNT_TYPE='CR' AND CDD.AMOUNT > 0 THEN CDD.AMOUNT ELSE   
(CASE WHEN CDD.AMOUNT_TYPE='DR' AND CDD.AMOUNT < 0 THEN CDD.AMOUNT * -1 ELSE 0 END)   
END)   
GROUP BY CDD.BANK_ACCOUNT_ID,CD.BANK_ACCOUNT_ID,AP.ACCT_YEAR,AP.ACCT_PERIOD, 
AG.COMPANY_NAME,AG.VAT_REGISTRATION,CDD.GL_ACCOUNT_ID
,A.DESCRIPTION ,CDD.POSTING_DATE ,CD.CONTROL_NO,CDD.CONTROL_NO
,APA.ID,CHQ.TIPO_CAB,CHQ.TELECREDITO_CAB,CHQ.CHECK_ID  
,CHQ.TIPO_DET,CHQ.TELECREDITO_DET,V.ID,CD.NAME,V.NAME,
ISNULL(CHQ.DESCRIPCION_OPER,EFE.DESCRIPCION_OPER) ,  
CDD.BATCH_ID,CDD.CURRENCY_ID,CDD.ENTITY_ID,CDD.POSTING_STATUS 
,AG1.PAYB_BANK_ACCOUNT_ID_LETTER
,CDD.DIST_NO 
UNION ALL  

--BAJ--  
SELECT   
'01' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
BAD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
BAD.POSTING_DATE AS FECHA_OPER,  
BAD.BANK_ACCOUNT_ID + ' - ' + BAD.ADJUSTMENT_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(BAD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(BAD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,(CASE WHEN ATDD.CHECK_ID IS NOT NULL THEN 'Transf. ' + ATDD.BANK_ACCOUNT_ID + ' - ' + ATDD.DEPOSIT_ID  
 WHEN ATDC.DEPOSIT_ID IS NOT NULL THEN 'Transf. ' + ATDC.BANK_ACCOUNT_ID + ' - ' + ATDC.DEPOSIT_ID  
ELSE BAD.BANK_ACCOUNT_ID + ' - ' + BAD.ADJUSTMENT_ID  END) AS DOC_SUSTENTATORIO,  
'BAJ ' +   
LEFT(((CASE WHEN ATDD.CHECK_ID IS NOT NULL THEN 'Transf. ' + ATDD.BANK_ACCOUNT_ID + ' - ' + ATDD.DEPOSIT_ID  
 WHEN ATDC.DEPOSIT_ID IS NOT NULL THEN 'Transf. ' + ATDC.BANK_ACCOUNT_ID + ' - ' + ATDC.DEPOSIT_ID  
ELSE BAD.BANK_ACCOUNT_ID + ' - ' + BAD.ADJUSTMENT_ID  END) + SPACE(30)),30)   
+ '  ' + ISNULL(BAJ.REFERENCE,BA.DESCRIPTION) AS GLOSA,  
ISNULL(BAJ.REFERENCE,BA.DESCRIPTION) AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN BAD.AMOUNT_TYPE='DR' AND BAD.AMOUNT > 0 THEN BAD.AMOUNT ELSE   
(CASE WHEN BAD.AMOUNT_TYPE='CR' AND BAD.AMOUNT < 0 THEN BAD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN BAD.AMOUNT_TYPE='CR' AND BAD.AMOUNT > 0 THEN BAD.AMOUNT ELSE   
(CASE WHEN BAD.AMOUNT_TYPE='DR' AND BAD.AMOUNT < 0 THEN BAD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN BAD.AMOUNT_TYPE='DR' AND BAD.AMOUNT > 0 THEN BAD.AMOUNT ELSE   
(CASE WHEN BAD.AMOUNT_TYPE='CR' AND BAD.AMOUNT < 0 THEN BAD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN BAD.AMOUNT_TYPE='CR' AND BAD.AMOUNT > 0 THEN BAD.AMOUNT ELSE   
(CASE WHEN BAD.AMOUNT_TYPE='DR' AND BAD.AMOUNT < 0 THEN BAD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN BAD.AMOUNT_TYPE='DR' AND BAD.AMOUNT > 0 THEN BAD.AMOUNT ELSE   
(CASE WHEN BAD.AMOUNT_TYPE='CR' AND BAD.AMOUNT < 0 THEN BAD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN BAD.AMOUNT_TYPE='CR' AND BAD.AMOUNT > 0 THEN BAD.AMOUNT ELSE   
(CASE WHEN BAD.AMOUNT_TYPE='DR' AND BAD.AMOUNT < 0 THEN BAD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN (SUM(CASE WHEN BAD.AMOUNT_TYPE='DR' AND BAD.AMOUNT > 0 THEN BAD.AMOUNT ELSE   
(CASE WHEN BAD.AMOUNT_TYPE='CR' AND BAD.AMOUNT < 0 THEN BAD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN BAD.AMOUNT_TYPE='CR' AND BAD.AMOUNT > 0 THEN BAD.AMOUNT ELSE   
(CASE WHEN BAD.AMOUNT_TYPE='DR' AND BAD.AMOUNT < 0 THEN BAD.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
BAD.BATCH_ID AS BATCH,  
BAD.CURRENCY_ID AS MONEDA,  
BAD.ENTITY_ID AS ENTIDAD,  
BAD.POSTING_STATUS AS ASENTADO  
,'05. BAJ - Ajuste de Bancos' AS TIPO  
,'BAJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,BAD.BANK_ACCOUNT_ID AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,BAD.ADJUSTMENT_ID AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM BANK_ADJ_DIST BAD   
INNER JOIN BANK_ADJUSTMENT BAJ ON BAD.BANK_ACCOUNT_ID = BAJ.BANK_ACCOUNT_ID AND BAD.ADJUSTMENT_ID = BAJ.ADJUSTMENT_ID  
INNER JOIN BANK_ACCOUNT BA ON BAD.BANK_ACCOUNT_ID = BA.ID  
INNER JOIN ACCOUNT A ON A.ID = BAD.GL_ACCOUNT_ID  
INNER JOIN ACCOUNT_PERIOD AP ON BAD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON BAJ.ENTITY_ID=AG.MFG_ENTITY_ID  
LEFT OUTER JOIN ARG_TRANS_DEP_DET ATDD ON ATDD.BANK_INGRESO=BAJ.BANK_ACCOUNT_ID AND ATDD.CHECK_ID=BAJ.ADJUSTMENT_ID  
LEFT OUTER JOIN ARG_TRANS_DEP_CAB ATDC ON ATDC.BANK_ACCOUNT_ID=BAJ.BANK_ACCOUNT_ID AND ATDC.DEPOSIT_ID=BAJ.ADJUSTMENT_ID  
WHERE BAD.BANK_ACCOUNT_ID+BAD.ADJUSTMENT_ID NOT IN 
(SELECT BANK_ACCOUNT_ID + DEPOSIT_ID  FROM ARG_TRANS_DEP_CAB )
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION  
,BAD.GL_ACCOUNT_ID ,A.DESCRIPTION,BAD.POSTING_DATE 
,BAD.BANK_ACCOUNT_ID ,BAD.ADJUSTMENT_ID 
,ATDD.CHECK_ID,ATDD.BANK_ACCOUNT_ID ,ATDD.DEPOSIT_ID  
,ATDC.DEPOSIT_ID,ATDC.BANK_ACCOUNT_ID,ATDC.DEPOSIT_ID  
,ISNULL(BAJ.REFERENCE,BA.DESCRIPTION) 
,BAD.BATCH_ID ,BAD.CURRENCY_ID ,BAD.ENTITY_ID ,BAD.POSTING_STATUS 
,BAD.DIST_NO 
UNION ALL  
--GJ--  
SELECT   
ISNULL(AGJ.LIBRO_ID,'05') AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
GJD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
GJD.POSTING_DATE AS FECHA_OPER,  
'AS-'+GJD.GJ_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(GJD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(GJD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,GJD.GJ_ID AS DOC_SUSTENTATORIO,  
'GJ ' + LEFT((GJD.GJ_ID + SPACE(15)),15) + '  ' + G.DESCRIPTION AS GLOSA,  
'' AS ANOTACION, 
CASE WHEN 
SUM(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN 
(SUM(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
GJD.BATCH_ID AS BATCH,  
GJD.CURRENCY_ID AS MONEDA,  
GJD.ENTITY_ID AS ENTIDAD,  
GJD.POSTING_STATUS AS ASENTADO,  
'06. GJ - Asientos Manuales' AS TIPO  
,'GJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,GJD.GJ_ID AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM GJ_DIST GJD  
INNER JOIN GJ G ON GJD.GJ_ID=G.ID  
INNER JOIN ACCOUNT A ON GJD.GL_ACCOUNT_ID=A.ID  
INNER JOIN ACCOUNT_PERIOD AP ON GJD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON GJD.ENTITY_ID=AG.MFG_ENTITY_ID  
LEFT OUTER JOIN ARG_GJ AGJ ON G.ID=AGJ.GJ_ID  
WHERE G.ID NOT IN (SELECT DISTINCT GJ_ID FROM ARG_GJ_LINE WHERE AN_SUBDIARIO IS NOT NULL)  
--AND GJD.CURRENCY_ID ='SOL'
GROUP BY AGJ.LIBRO_ID,AP.ACCT_YEAR,AP.ACCT_PERIOD
,AG.COMPANY_NAME,AG.VAT_REGISTRATION,GJD.GL_ACCOUNT_ID
,A.DESCRIPTION,GJD.POSTING_DATE,GJD.GJ_ID,G.DESCRIPTION ,
GJD.BATCH_ID,GJD.CURRENCY_ID,GJD.ENTITY_ID,GJD.POSTING_STATUS 
,GJD.DIST_NO 
UNION ALL  
--RVJ--  
SELECT   
'05' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
RVD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
RVD.POSTING_DATE AS FECHA_OPER,  
RVD.REVALUE_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(RVD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(RVD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,RVD.REVALUE_ID AS DOC_SUSTENTATORIO,  
'RVJ  ' + LEFT((RVD.REVALUE_ID + SPACE(15)),15) + LEFT(( RVD.REVALUE_ID + SPACE(15)),15) AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN RVD.AMOUNT_TYPE='DR' AND RVD.AMOUNT > 0 THEN RVD.AMOUNT ELSE   
(CASE WHEN RVD.AMOUNT_TYPE='CR' AND RVD.AMOUNT < 0 THEN RVD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RVD.AMOUNT_TYPE='CR' AND RVD.AMOUNT > 0 THEN RVD.AMOUNT ELSE   
(CASE WHEN RVD.AMOUNT_TYPE='DR' AND RVD.AMOUNT < 0 THEN RVD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN RVD.AMOUNT_TYPE='DR' AND RVD.AMOUNT > 0 THEN RVD.AMOUNT ELSE   
(CASE WHEN RVD.AMOUNT_TYPE='CR' AND RVD.AMOUNT < 0 THEN RVD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RVD.AMOUNT_TYPE='CR' AND RVD.AMOUNT > 0 THEN RVD.AMOUNT ELSE   
(CASE WHEN RVD.AMOUNT_TYPE='DR' AND RVD.AMOUNT < 0 THEN RVD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN RVD.AMOUNT_TYPE='DR' AND RVD.AMOUNT > 0 THEN RVD.AMOUNT ELSE   
(CASE WHEN RVD.AMOUNT_TYPE='CR' AND RVD.AMOUNT < 0 THEN RVD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RVD.AMOUNT_TYPE='CR' AND RVD.AMOUNT > 0 THEN RVD.AMOUNT ELSE   
(CASE WHEN RVD.AMOUNT_TYPE='DR' AND RVD.AMOUNT < 0 THEN RVD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN 
(SUM(CASE WHEN RVD.AMOUNT_TYPE='DR' AND RVD.AMOUNT > 0 THEN RVD.AMOUNT ELSE   
(CASE WHEN RVD.AMOUNT_TYPE='CR' AND RVD.AMOUNT < 0 THEN RVD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN RVD.AMOUNT_TYPE='CR' AND RVD.AMOUNT > 0 THEN RVD.AMOUNT ELSE   
(CASE WHEN RVD.AMOUNT_TYPE='DR' AND RVD.AMOUNT < 0 THEN RVD.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
RVD.BATCH_ID AS BATCH,  
RVD.CURRENCY_ID AS MONEDA,  
RVD.ENTITY_ID AS ENTIDAD,  
RVD.POSTING_STATUS AS ASENTADO  
,'12. RVJ - Revaluación' AS TIPO  
,'RVJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,RVD.REVALUE_ID AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM REVALUE_DIST RVD, ACCOUNT A, APPLICATION_GLOBAL AG,ACCOUNT_PERIOD AP  
WHERE A.ID = RVD.GL_ACCOUNT_ID   
AND RVD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,RVD.GL_ACCOUNT_ID,A.DESCRIPTION,RVD.POSTING_DATE,RVD.REVALUE_ID
,RVD.BATCH_ID,RVD.CURRENCY_ID,RVD.ENTITY_ID,RVD.POSTING_STATUS 
 ,RVD.DIST_NO 
UNION ALL  

--PUR--  

SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
POD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
POD.POSTING_DATE AS FECHA_OPER,  
POD.PURC_ORDER_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(POD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(POD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,POD.PURC_ORDER_ID AS DOC_SUSTENTATORIO,  
'PUR ' + LEFT((POD.PURC_ORDER_ID + SPACE(15)),15) + LEFT(( V.ID + SPACE(15)),15) + '  ' + V.NAME AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN POD.AMOUNT_TYPE='DR' AND POD.AMOUNT > 0 THEN POD.AMOUNT ELSE   
(CASE WHEN POD.AMOUNT_TYPE='CR' AND POD.AMOUNT < 0 THEN POD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN POD.AMOUNT_TYPE='CR' AND POD.AMOUNT > 0 THEN POD.AMOUNT ELSE   
(CASE WHEN POD.AMOUNT_TYPE='DR' AND POD.AMOUNT < 0 THEN POD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN POD.AMOUNT_TYPE='DR' AND POD.AMOUNT > 0 THEN POD.AMOUNT ELSE   
(CASE WHEN POD.AMOUNT_TYPE='CR' AND POD.AMOUNT < 0 THEN POD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN POD.AMOUNT_TYPE='CR' AND POD.AMOUNT > 0 THEN POD.AMOUNT ELSE   
(CASE WHEN POD.AMOUNT_TYPE='DR' AND POD.AMOUNT < 0 THEN POD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN POD.AMOUNT_TYPE='DR' AND POD.AMOUNT > 0 THEN POD.AMOUNT ELSE   
(CASE WHEN POD.AMOUNT_TYPE='CR' AND POD.AMOUNT < 0 THEN POD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN POD.AMOUNT_TYPE='CR' AND POD.AMOUNT > 0 THEN POD.AMOUNT ELSE   
(CASE WHEN POD.AMOUNT_TYPE='DR' AND POD.AMOUNT < 0 THEN POD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN 
(SUM(CASE WHEN POD.AMOUNT_TYPE='DR' AND POD.AMOUNT > 0 THEN POD.AMOUNT ELSE   
(CASE WHEN POD.AMOUNT_TYPE='CR' AND POD.AMOUNT < 0 THEN POD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN POD.AMOUNT_TYPE='CR' AND POD.AMOUNT > 0 THEN POD.AMOUNT ELSE   
(CASE WHEN POD.AMOUNT_TYPE='DR' AND POD.AMOUNT < 0 THEN POD.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
POD.BATCH_ID AS BATCH,  
POD.CURRENCY_ID AS MONEDA,  
POD.ENTITY_ID AS ENTIDAD,  
POD.POSTING_STATUS AS ASENTADO  
,'07. PUR - Recibos Compras' AS TIPO  
,'PUR' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,POD.PURC_ORDER_ID AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,V.ID AS CODIGO_CLIPROV  
,V.NAME AS RAZON_SOCIAL_CLIPROV  
FROM PURCHASE_DIST POD, PURCHASE_ORDER PO, VENDOR V, ACCOUNT A, APPLICATION_GLOBAL AG,ACCOUNT_PERIOD AP  
WHERE POD.PURC_ORDER_ID = PO.ID  
AND PO.VENDOR_ID = V.ID  
AND A.ID = POD.GL_ACCOUNT_ID  
AND POD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,POD.GL_ACCOUNT_ID,A.DESCRIPTION,POD.POSTING_DATE,POD.PURC_ORDER_ID
,V.ID,V.NAME,POD.BATCH_ID,POD.CURRENCY_ID,POD.ENTITY_ID,POD.POSTING_STATUS 
,POD.DIST_NO  

UNION ALL  

--WIP--  

SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
WID.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
WID.POSTING_DATE AS FECHA_OPER,  
'W'+WID.WORKORDER_BASE_ID + ' / ' + WID.WORKORDER_LOT_ID AS NRO_CORRELAT,  
'M'+'WIP'+RIGHT(REPLICATE('0',2)+CAST(WID.DIST_NO AS VARCHAR(2)),2) 
 +RIGHT(REPLICATE('0',2)+CAST(MAX(WID.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,WID.WORKORDER_BASE_ID AS DOC_SUSTENTATORIO,  
'WIP ' + LEFT((WID.WORKORDER_BASE_ID + SPACE(15)),15) + LEFT(( WID.WORKORDER_LOT_ID + SPACE(15)),15) + '  ' + WO.PART_ID + '  ' + PA.DESCRIPTION AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN (
SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
WID.BATCH_ID AS BATCH,  
WID.CURRENCY_ID AS MONEDA,  
WID.ENTITY_ID AS ENTIDAD,  
WID.POSTING_STATUS AS ASENTADO  
,'08. WIP - Producción en Proceso' AS TIPO  
,WID.TYPE AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,WID.WORKORDER_TYPE AS WORKORDER_TYPE  
,WID.WORKORDER_BASE_ID AS WORKORDER_BASE_ID  
,WID.WORKORDER_LOT_ID AS WORKORDER_LOT_ID  
,WID.WORKORDER_SPLIT_ID AS WORKORDER_SPLIT_ID  
,WID.WORKORDER_SUB_ID AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM  APPLICATION_GLOBAL AG,-- WIP_ISSUE_DIST WID  
(SELECT 'WIP' AS TYPE,* FROM WIP_ISSUE_DIST) WID  
INNER JOIN WORK_ORDER WO ON WID.WORKORDER_TYPE = WO.TYPE  
AND WID.WORKORDER_BASE_ID = WO.BASE_ID  
AND WID.WORKORDER_LOT_ID = WO.LOT_ID  
AND WID.WORKORDER_SPLIT_ID = WO.SPLIT_ID  
AND WID.WORKORDER_SUB_ID = WO.SUB_ID  
INNER JOIN ACCOUNT A ON  A.ID = WID.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON WID.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN PART PA ON WO.PART_ID = PA.ID  
WHERE AG.ID = 1  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,WID.GL_ACCOUNT_ID,A.DESCRIPTION,WID.POSTING_DATE,WID.WORKORDER_BASE_ID
,WID.WORKORDER_LOT_ID,WO.PART_ID,PA.DESCRIPTION
,WID.WORKORDER_TYPE,WID.WORKORDER_SPLIT_ID,WID.WORKORDER_SUB_ID 
,WID.BATCH_ID,WID.CURRENCY_ID,WID.ENTITY_ID,WID.POSTING_STATUS
--AND WO.PART_ID IS NOT NULL  
,WID.DIST_NO,WID.TYPE 
UNION ALL  

SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
WID.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
WID.POSTING_DATE AS FECHA_OPER,  
'W'+WID.WORKORDER_BASE_ID + ' / ' + WID.WORKORDER_LOT_ID AS NRO_CORRELAT,  
'M'+'WIP'+RIGHT(REPLICATE('0',2)+CAST(WID.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(WID.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,WID.WORKORDER_BASE_ID AS DOC_SUSTENTATORIO,  
'WIP ' + LEFT((WID.WORKORDER_BASE_ID + SPACE(15)),15) + LEFT(( WID.WORKORDER_LOT_ID + SPACE(15)),15) + '  ' + CO.PART_ID + '  ' + PA.DESCRIPTION AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN 
(SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END)
)*-1 ELSE 0 END AS HABER ,    
WID.BATCH_ID AS BATCH,  
WID.CURRENCY_ID AS MONEDA,  
WID.ENTITY_ID AS ENTIDAD,  
WID.POSTING_STATUS AS ASENTADO  
,'08. WIPA - Producción en Proceso' AS TIPO  
,WID.TYPE  AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,WID.WORKORDER_TYPE AS WORKORDER_TYPE  
,WID.WORKORDER_BASE_ID AS WORKORDER_BASE_ID  
,WID.WORKORDER_LOT_ID AS WORKORDER_LOT_ID  
,WID.WORKORDER_SPLIT_ID AS WORKORDER_SPLIT_ID  
,WID.WORKORDER_SUB_ID AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM  APPLICATION_GLOBAL AG,
(SELECT 'WIP' AS TYPE,* FROM WIP_ISSUE_DIST) WID  
INNER JOIN WORK_ORDER WO ON WID.WORKORDER_TYPE = WO.TYPE  
AND WID.WORKORDER_BASE_ID = WO.BASE_ID  
AND WID.WORKORDER_LOT_ID = WO.LOT_ID  
AND WID.WORKORDER_SPLIT_ID = WO.SPLIT_ID  
AND WID.WORKORDER_SUB_ID = WO.SUB_ID  
INNER JOIN CO_PRODUCT CO ON CO.WORKORDER_TYPE = WO.TYPE  
AND CO.WORKORDER_BASE_ID = WO.BASE_ID  
AND CO.WORKORDER_LOT_ID = WO.LOT_ID  
AND CO.WORKORDER_SPLIT_ID = WO.SPLIT_ID  
AND CO.WORKORDER_SUB_ID = WO.SUB_ID  
INNER JOIN ACCOUNT A ON  A.ID = WID.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON WID.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN PART PA ON CO.PART_ID = PA.ID  
WHERE AG.ID = 1  
AND WO.PART_ID IS NULL  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,WID.GL_ACCOUNT_ID,A.DESCRIPTION,WID.POSTING_DATE,WID.WORKORDER_BASE_ID
,WID.WORKORDER_LOT_ID,CO.PART_ID,PA.DESCRIPTION
,WID.WORKORDER_TYPE,WID.WORKORDER_SPLIT_ID,WID.WORKORDER_SUB_ID 
,WID.BATCH_ID,WID.CURRENCY_ID,WID.ENTITY_ID,WID.POSTING_STATUS
,WID.DIST_NO,WID.TYPE 
    
UNION ALL  
  
SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
WID.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
WID.POSTING_DATE AS FECHA_OPER,  
'W'+WID.WORKORDER_BASE_ID + ' / ' + WID.WORKORDER_LOT_ID AS NRO_CORRELAT,  
'M'+'WIP'+RIGHT(REPLICATE('0',2)+CAST(WID.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(WID.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,WID.WORKORDER_BASE_ID AS DOC_SUSTENTATORIO,  
'WIP ' + LEFT((WID.WORKORDER_BASE_ID + SPACE(15)),15) + LEFT(( WID.WORKORDER_LOT_ID + SPACE(15)),15) + '  ' + '  '  AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN (SUM(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WID.AMOUNT_TYPE='CR' AND WID.AMOUNT > 0 THEN WID.AMOUNT ELSE   
(CASE WHEN WID.AMOUNT_TYPE='DR' AND WID.AMOUNT < 0 THEN WID.AMOUNT * -1 ELSE 0 END)   
END))*-1 ELSE 0 END AS HABER ,    
WID.BATCH_ID AS BATCH,  
WID.CURRENCY_ID AS MONEDA,  
WID.ENTITY_ID AS ENTIDAD,  
WID.POSTING_STATUS AS ASENTADO  
,'08. WIPA - Producción en Proceso' AS TIPO  
,WID.TYPE AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,WID.WORKORDER_TYPE AS WORKORDER_TYPE  
,WID.WORKORDER_BASE_ID AS WORKORDER_BASE_ID  
,WID.WORKORDER_LOT_ID AS WORKORDER_LOT_ID  
,WID.WORKORDER_SPLIT_ID AS WORKORDER_SPLIT_ID  
,WID.WORKORDER_SUB_ID AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM  APPLICATION_GLOBAL AG, 
(SELECT 'WIP' AS TYPE,* FROM WIP_ISSUE_DIST) WID  
INNER JOIN WORK_ORDER WO ON WID.WORKORDER_TYPE = WO.TYPE  
AND WID.WORKORDER_BASE_ID = WO.BASE_ID  
AND WID.WORKORDER_LOT_ID = WO.LOT_ID  
AND WID.WORKORDER_SPLIT_ID = WO.SPLIT_ID  
AND WID.WORKORDER_SUB_ID = WO.SUB_ID  
LEFT OUTER JOIN CO_PRODUCT CO ON CO.WORKORDER_TYPE = WO.TYPE  
AND CO.WORKORDER_BASE_ID = WO.BASE_ID  
AND CO.WORKORDER_LOT_ID = WO.LOT_ID  
AND CO.WORKORDER_SPLIT_ID = WO.SPLIT_ID  
AND CO.WORKORDER_SUB_ID = WO.SUB_ID  
INNER JOIN ACCOUNT A ON  A.ID = WID.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON WID.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
--INNER JOIN PART PA ON CO.PART_ID = PA.ID  
WHERE AG.ID = 1  
AND WO.PART_ID IS NULL  
AND CO.PART_ID IS NULL  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,WID.GL_ACCOUNT_ID,A.DESCRIPTION,WID.POSTING_DATE,WID.WORKORDER_BASE_ID
,WID.WORKORDER_LOT_ID,WID.WORKORDER_TYPE,WID.WORKORDER_SPLIT_ID,WID.WORKORDER_SUB_ID 
,WID.BATCH_ID,WID.CURRENCY_ID,WID.ENTITY_ID,WID.POSTING_STATUS
,WID.DIST_NO,WID.TYPE 
UNION ALL  
--FG--  

SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
WRD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
WRD.POSTING_DATE AS FECHA_OPER,  
'F'+WRD.WORKORDER_BASE_ID + ' / ' + WRD.WORKORDER_LOT_ID AS NRO_CORRELAT,  
'M'+'FG'+RIGHT(REPLICATE('0',2)+CAST(WRD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(WRD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,WRD.WORKORDER_BASE_ID AS DOC_SUSTENTATORIO,  
'FG ' + LEFT((WRD.WORKORDER_BASE_ID + SPACE(15)),15) + LEFT(( WRD.WORKORDER_LOT_ID + SPACE(15)),15) + '  ' + WO.PART_ID + '  ' + PA.DESCRIPTION AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN (SUM(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END))*-1 ELSE 0 END AS HABER ,    
WRD.BATCH_ID AS BATCH,  
WRD.CURRENCY_ID AS MONEDA,  
WRD.ENTITY_ID AS ENTIDAD,  
WRD.POSTING_STATUS AS ASENTADO  
,'09. FG - Producto Terminado' AS TIPO  
,'FG' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,WRD.WORKORDER_TYPE AS WORKORDER_TYPE  
,WRD.WORKORDER_BASE_ID AS WORKORDER_BASE_ID  
,WRD.WORKORDER_LOT_ID AS WORKORDER_LOT_ID  
,WRD.WORKORDER_SPLIT_ID AS WORKORDER_SPLIT_ID  
,WRD.WORKORDER_SUB_ID AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM APPLICATION_GLOBAL AG, WIP_RECEIPT_DIST WRD  
INNER JOIN WORK_ORDER WO ON WRD.WORKORDER_TYPE = WO.TYPE  
AND WRD.WORKORDER_BASE_ID = WO.BASE_ID  
AND WRD.WORKORDER_LOT_ID = WO.LOT_ID  
AND WRD.WORKORDER_SPLIT_ID = WO.SPLIT_ID  
AND WRD.WORKORDER_SUB_ID = WO.SUB_ID  
INNER JOIN ACCOUNT A ON A.ID = WRD.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON WRD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN PART PA ON WO.PART_ID = PA.ID  
WHERE AG.ID = 1  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,WRD.GL_ACCOUNT_ID,A.DESCRIPTION,WRD.POSTING_DATE,WRD.WORKORDER_BASE_ID
,WRD.WORKORDER_LOT_ID,WO.PART_ID,PA.DESCRIPTION
,WRD.WORKORDER_TYPE,WRD.WORKORDER_SPLIT_ID,WRD.WORKORDER_SUB_ID 
,WRD.BATCH_ID,WRD.CURRENCY_ID,WRD.ENTITY_ID,WRD.POSTING_STATUS
,WRD.DIST_NO 

UNION ALL  

SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
WRD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
WRD.POSTING_DATE AS FECHA_OPER,  
'F' + WRD.WORKORDER_BASE_ID + ' / ' + WRD.WORKORDER_LOT_ID AS NRO_CORRELAT,  
'M'+'FG'+RIGHT(REPLICATE('0',2)+CAST(WRD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(WRD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,WRD.WORKORDER_BASE_ID AS DOC_SUSTENTATORIO,  
'FG ' + LEFT((WRD.WORKORDER_BASE_ID + SPACE(15)),15) + LEFT(( WRD.WORKORDER_LOT_ID + SPACE(15)),15) + '  ' + CO.PART_ID + '  ' + PA.DESCRIPTION AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN (SUM(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN WRD.AMOUNT_TYPE='CR' AND WRD.AMOUNT > 0 THEN WRD.AMOUNT ELSE   
(CASE WHEN WRD.AMOUNT_TYPE='DR' AND WRD.AMOUNT < 0 THEN WRD.AMOUNT * -1 ELSE 0 END)   
END))*-1 ELSE 0 END AS HABER ,    
WRD.BATCH_ID AS BATCH,  
WRD.CURRENCY_ID AS MONEDA,  
WRD.ENTITY_ID AS ENTIDAD,  
WRD.POSTING_STATUS AS ASENTADO  
,'09. FG - Producto Terminado' AS TIPO  
,'FG' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,WRD.WORKORDER_TYPE AS WORKORDER_TYPE  
,WRD.WORKORDER_BASE_ID AS WORKORDER_BASE_ID  
,WRD.WORKORDER_LOT_ID AS WORKORDER_LOT_ID  
,WRD.WORKORDER_SPLIT_ID AS WORKORDER_SPLIT_ID  
,WRD.WORKORDER_SUB_ID AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM APPLICATION_GLOBAL AG, WIP_RECEIPT_DIST WRD  
INNER JOIN WORK_ORDER WO ON WRD.WORKORDER_TYPE = WO.TYPE  
AND WRD.WORKORDER_BASE_ID = WO.BASE_ID  
AND WRD.WORKORDER_LOT_ID = WO.LOT_ID  
AND WRD.WORKORDER_SPLIT_ID = WO.SPLIT_ID  
AND WRD.WORKORDER_SUB_ID = WO.SUB_ID  
INNER JOIN CO_PRODUCT CO ON CO.WORKORDER_TYPE = WO.TYPE  
AND CO.WORKORDER_BASE_ID = WO.BASE_ID  
AND CO.WORKORDER_LOT_ID = WO.LOT_ID  
AND CO.WORKORDER_SPLIT_ID = WO.SPLIT_ID  
AND CO.WORKORDER_SUB_ID = WO.SUB_ID  
INNER JOIN ACCOUNT A ON A.ID = WRD.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON WRD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN PART PA ON CO.PART_ID = PA.ID  
WHERE AG.ID = 1  
AND WO.PART_ID IS NULL  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,WRD.GL_ACCOUNT_ID,A.DESCRIPTION,WRD.POSTING_DATE,WRD.WORKORDER_BASE_ID
,WRD.WORKORDER_LOT_ID,CO.PART_ID,PA.DESCRIPTION
,WRD.WORKORDER_TYPE,WRD.WORKORDER_SPLIT_ID,WRD.WORKORDER_SUB_ID 
,WRD.BATCH_ID,WRD.CURRENCY_ID,WRD.ENTITY_ID,WRD.POSTING_STATUS
,WRD.DIST_NO 
UNION ALL
  
--SLS--  
SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
SD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
SD.POSTING_DATE AS FECHA_OPER,  
SD.CUST_ORDER_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(SD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(SD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,SD.CUST_ORDER_ID AS DOC_SUSTENTATORIO,  
'SLS ' + LEFT((SD.CUST_ORDER_ID + SPACE(15)),15) + LEFT(( C.ID + SPACE(15)),15) + '  ' + C.NAME AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN SD.AMOUNT_TYPE='DR' AND SD.AMOUNT > 0 THEN SD.AMOUNT ELSE   
(CASE WHEN SD.AMOUNT_TYPE='CR' AND SD.AMOUNT < 0 THEN SD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN SD.AMOUNT_TYPE='CR' AND SD.AMOUNT > 0 THEN SD.AMOUNT ELSE   
(CASE WHEN SD.AMOUNT_TYPE='DR' AND SD.AMOUNT < 0 THEN SD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN SD.AMOUNT_TYPE='DR' AND SD.AMOUNT > 0 THEN SD.AMOUNT ELSE   
(CASE WHEN SD.AMOUNT_TYPE='CR' AND SD.AMOUNT < 0 THEN SD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN SD.AMOUNT_TYPE='CR' AND SD.AMOUNT > 0 THEN SD.AMOUNT ELSE   
(CASE WHEN SD.AMOUNT_TYPE='DR' AND SD.AMOUNT < 0 THEN SD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN SD.AMOUNT_TYPE='DR' AND SD.AMOUNT > 0 THEN SD.AMOUNT ELSE   
(CASE WHEN SD.AMOUNT_TYPE='CR' AND SD.AMOUNT < 0 THEN SD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN SD.AMOUNT_TYPE='CR' AND SD.AMOUNT > 0 THEN SD.AMOUNT ELSE   
(CASE WHEN SD.AMOUNT_TYPE='DR' AND SD.AMOUNT < 0 THEN SD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN (SUM(CASE WHEN SD.AMOUNT_TYPE='DR' AND SD.AMOUNT > 0 THEN SD.AMOUNT ELSE   
(CASE WHEN SD.AMOUNT_TYPE='CR' AND SD.AMOUNT < 0 THEN SD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN SD.AMOUNT_TYPE='CR' AND SD.AMOUNT > 0 THEN SD.AMOUNT ELSE   
(CASE WHEN SD.AMOUNT_TYPE='DR' AND SD.AMOUNT < 0 THEN SD.AMOUNT * -1 ELSE 0 END)   
END))*-1 ELSE 0 END AS HABER ,       
SD.BATCH_ID AS BATCH,  
SD.CURRENCY_ID AS MONEDA,  
SD.ENTITY_ID AS ENTIDAD,  
SD.POSTING_STATUS AS ASENTADO  
,'10. SLS - Despachos' AS TIPO  
,'SLS' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,SD.CUST_ORDER_ID AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,C.ID AS CODIGO_CLIPROV  
,C.NAME AS RAZON_SOCIAL_CLIPROV  
FROM SHIPMENT_DIST SD, CUSTOMER_ORDER CO, CUSTOMER C, ACCOUNT A, APPLICATION_GLOBAL AG,ACCOUNT_PERIOD AP  
WHERE SD.CUST_ORDER_ID = CO.ID  
AND CO.CUSTOMER_ID = C.ID  
AND A.ID = SD.GL_ACCOUNT_ID   
AND AG.ID = 1  
AND SD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,SD.GL_ACCOUNT_ID,A.DESCRIPTION,SD.POSTING_DATE,SD.CUST_ORDER_ID 
,C.ID,C.NAME,SD.BATCH_ID,SD.CURRENCY_ID,SD.ENTITY_ID,SD.POSTING_STATUS
,SD.DIST_NO 
--ADJ--  
UNION ALL  
SELECT   
'13' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
AD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
AD.POSTING_DATE AS FECHA_OPER,  
'TRN-'+CAST(AD.TRANSACTION_ID AS VARCHAR (15)) AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(AD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(MAX(AD.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,CAST(AD.TRANSACTION_ID AS VARCHAR (15)) AS DOC_SUSTENTATORIO,  
'ADJ ' + LEFT((CAST(AD.TRANSACTION_ID AS VARCHAR (15)) + SPACE(15)),15) + LEFT(( IT.WAREHOUSE_ID + ' ' + IT.LOCATION_ID + SPACE(15)),15) + '  ' + IT.PART_ID + '  ' + PA.DESCRIPTION AS GLOSA,  
'' AS ANOTACION,  
CASE WHEN 
SUM(CASE WHEN AD.AMOUNT_TYPE='DR' AND AD.AMOUNT > 0 THEN AD.AMOUNT ELSE   
(CASE WHEN AD.AMOUNT_TYPE='CR' AND AD.AMOUNT < 0 THEN AD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN AD.AMOUNT_TYPE='CR' AND AD.AMOUNT > 0 THEN AD.AMOUNT ELSE   
(CASE WHEN AD.AMOUNT_TYPE='DR' AND AD.AMOUNT < 0 THEN AD.AMOUNT * -1 ELSE 0 END)   
END)>0
THEN SUM(CASE WHEN AD.AMOUNT_TYPE='DR' AND AD.AMOUNT > 0 THEN AD.AMOUNT ELSE   
(CASE WHEN AD.AMOUNT_TYPE='CR' AND AD.AMOUNT < 0 THEN AD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN AD.AMOUNT_TYPE='CR' AND AD.AMOUNT > 0 THEN AD.AMOUNT ELSE   
(CASE WHEN AD.AMOUNT_TYPE='DR' AND AD.AMOUNT < 0 THEN AD.AMOUNT * -1 ELSE 0 END)   
END) ELSE 0 END AS DEBE ,    
CASE WHEN 
SUM(CASE WHEN AD.AMOUNT_TYPE='DR' AND AD.AMOUNT > 0 THEN AD.AMOUNT ELSE   
(CASE WHEN AD.AMOUNT_TYPE='CR' AND AD.AMOUNT < 0 THEN AD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN AD.AMOUNT_TYPE='CR' AND AD.AMOUNT > 0 THEN AD.AMOUNT ELSE   
(CASE WHEN AD.AMOUNT_TYPE='DR' AND AD.AMOUNT < 0 THEN AD.AMOUNT * -1 ELSE 0 END)   
END)<0
THEN (SUM(CASE WHEN AD.AMOUNT_TYPE='DR' AND AD.AMOUNT > 0 THEN AD.AMOUNT ELSE   
(CASE WHEN AD.AMOUNT_TYPE='CR' AND AD.AMOUNT < 0 THEN AD.AMOUNT * -1 ELSE 0 END)   
END) 
-
SUM(CASE WHEN AD.AMOUNT_TYPE='CR' AND AD.AMOUNT > 0 THEN AD.AMOUNT ELSE   
(CASE WHEN AD.AMOUNT_TYPE='DR' AND AD.AMOUNT < 0 THEN AD.AMOUNT * -1 ELSE 0 END)   
END))*-1 ELSE 0 END AS HABER ,       
AD.BATCH_ID AS BATCH,  
AD.CURRENCY_ID AS MONEDA,  
AD.ENTITY_ID AS ENTIDAD,  
AD.POSTING_STATUS AS ASENTADO  
,'11. ADJ - Ajuste Inventario' AS TIPO  
,'ADJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,NULL AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,AD.TRANSACTION_ID AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM ADJUSTMENT_DIST AD, INVENTORY_TRANS IT, PART PA, ACCOUNT A, APPLICATION_GLOBAL AG,ACCOUNT_PERIOD AP  
WHERE AD.TRANSACTION_ID = IT.TRANSACTION_ID  
AND IT.PART_ID = PA.ID  
AND A.ID = AD.GL_ACCOUNT_ID   
AND AG.ID = 1  
AND AD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD,AG.COMPANY_NAME,AG.VAT_REGISTRATION
,AD.GL_ACCOUNT_ID,A.DESCRIPTION,AD.POSTING_DATE,AD.TRANSACTION_ID
,IT.WAREHOUSE_ID,IT.LOCATION_ID,IT.PART_ID,PA.DESCRIPTION
,AD.BATCH_ID,AD.CURRENCY_ID,AD.ENTITY_ID,AD.POSTING_STATUS
,AD.DIST_NO 
----ANALITICAS MANUFACTURA  

UNION ALL  
  
SELECT   
'13' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
GL.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
GD.POSTING_DATE AS FECHA_OPER,  
'TRN-'+CAST(AGL.AN_CLAVE AS VARCHAR (15)) AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',4)+CAST(GL.LINE_NO AS  VARCHAR(4)),4) AS SUB_CODIGO
 --+ RIGHT(REPLICATE('0',2)+CAST(MAX(GJ.ENTRY_NO)  AS VARCHAR(2)),2) AS SUB_CODIGO
,CAST(AGL.AN_CLAVE AS VARCHAR (15)) AS DOC_SUSTENTATORIO,  
'ADJ ' + LEFT((CAST(AGL.AN_CLAVE AS VARCHAR (15)) + SPACE(15)),15) + LEFT(( IT.WAREHOUSE_ID + ' ' + IT.LOCATION_ID + SPACE(15)),15) + '  ' + IT.PART_ID + '  ' + PA.DESCRIPTION AS GLOSA,  
'' AS ANOTACION,  
GL.DEBIT_AMOUNT AS DEBE,    
GL.CREDIT_AMOUNT AS HABER,    
GD.ID AS BATCH,  
GD.CURRENCY_ID AS MONEDA,  
GD.ENTITY_ID AS ENTIDAD,  
'P' AS ASENTADO  
,'11. ADJ - Ajuste Inventario' AS TIPO  
,'GJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,GD.ID AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM GJ GD  
INNER JOIN ARG_GJ_LINE AGL ON GD.ID=AGL.GJ_ID AND AGL.AN_SUBDIARIO='ADJ'   
INNER JOIN GJ_LINE GL ON GL.GJ_ID=AGL.GJ_ID AND GL.LINE_NO=AGL.LINE_NO  
INNER JOIN INVENTORY_TRANS IT ON AGL.AN_CLAVE=IT.TRANSACTION_ID  
INNER JOIN PART PA ON IT.PART_ID = PA.ID  
INNER JOIN ACCOUNT A ON A.ID = GL.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON GD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON AG.MFG_ENTITY_ID = AGL.ENTITY_ID  
--WHERE IT.TRANSACTION_ID=13942  
    
UNION ALL  

/*  
SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
GL.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
GD.POSTING_DATE AS FECHA_OPER,  
CAST(AGL.AN_CLAVE AS VARCHAR (15)) AS NRO_CORRELAT,  
CAST(AGL.AN_CLAVE AS VARCHAR (15)) AS DOC_SUSTENTATORIO,  
'PUR ' + LEFT((PO.ID + SPACE(15)),15) + LEFT(( V.ID + SPACE(15)),15) + '  ' + V.NAME AS GLOSA,  
'' AS ANOTACION,  
GL.DEBIT_AMOUNT AS DEBE,    
GL.CREDIT_AMOUNT AS HABER,    
GD.ID AS BATCH,  
GD.CURRENCY_ID AS MONEDA,  
GD.ENTITY_ID AS ENTIDAD,  
'P' AS ASENTADO  
,'07. PUR - Recibos Compras' AS TIPO  
,'GJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,GD.ID AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,V.ID AS CODIGO_CLIPROV  
,V.NAME AS RAZON_SOCIAL_CLIPROV  
FROM GJ GD  
INNER JOIN ARG_GJ_LINE AGL ON GD.ID=AGL.GJ_ID AND AGL.AN_SUBDIARIO='PUR'   
INNER JOIN GJ_LINE GL ON GL.GJ_ID=AGL.GJ_ID AND GL.LINE_NO=AGL.LINE_NO  
INNER JOIN PURCHASE_ORDER PO ON AGL.AN_CLAVE=PO.ID  
INNER JOIN VENDOR V ON PO.VENDOR_ID = V.ID  
INNER JOIN ACCOUNT A ON A.ID = GL.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON GD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON AG.MFG_ENTITY_ID = AGL.ENTITY_ID  
*/

SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
GL.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
GD.POSTING_DATE AS FECHA_OPER,  
CAST(AGL.AN_CLAVE AS VARCHAR (15)) AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',4)+CAST(GL.LINE_NO AS  VARCHAR(4)),4) AS SUB_CODIGO,
CAST(AGL.AN_CLAVE AS VARCHAR (15)) AS DOC_SUSTENTATORIO,  
'PUR ' + LEFT((PO.ID + SPACE(15)),15) + LEFT(( V.ID + SPACE(15)),15) + '  ' + V.NAME AS GLOSA,  
'' AS ANOTACION,  
SUM(GL.DEBIT_AMOUNT) AS DEBE,    
SUM(GL.CREDIT_AMOUNT) AS HABER,    
GD.ID AS BATCH,  
GD.CURRENCY_ID AS MONEDA,  
GD.ENTITY_ID AS ENTIDAD,  
'P' AS ASENTADO  
,'07. PUR - Recibos Compras' AS TIPO  
,'GJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,GD.ID AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,V.ID AS CODIGO_CLIPROV  
,V.NAME AS RAZON_SOCIAL_CLIPROV  
FROM GJ GD  
INNER JOIN ARG_GJ_LINE AGL ON GD.ID=AGL.GJ_ID AND AGL.AN_SUBDIARIO='PUR'   
INNER JOIN GJ_LINE GL ON GL.GJ_ID=AGL.GJ_ID AND GL.LINE_NO=AGL.LINE_NO  
INNER JOIN PURCHASE_ORDER PO ON AGL.AN_CLAVE=PO.ID  
INNER JOIN VENDOR V ON PO.VENDOR_ID = V.ID  
INNER JOIN ACCOUNT A ON A.ID = GL.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON GD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON AG.MFG_ENTITY_ID = AGL.ENTITY_ID  
GROUP BY AP.ACCT_YEAR,AP.ACCT_PERIOD
,AG.COMPANY_NAME,AG.VAT_REGISTRATION,GL.GL_ACCOUNT_ID
,A.DESCRIPTION,GD.POSTING_DATE,AGL.AN_CLAVE,AGL.AN_CLAVE,  
PO.ID,V.ID,V.NAME,GD.ID,GD.CURRENCY_ID,GD.ENTITY_ID 
,GL.LINE_NO    
  
UNION ALL  
  
SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
GL.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
GD.POSTING_DATE AS FECHA_OPER,  
'W'+CAST(AGL.AN_CLAVE AS VARCHAR (15))  + ' / ' + WO.LOT_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',4)+CAST(GL.LINE_NO AS  VARCHAR(4)),4) AS SUB_CODIGO,
CAST(AGL.AN_CLAVE AS VARCHAR (15)) AS DOC_SUSTENTATORIO,  
'WIP ' + LEFT((WO.BASE_ID + SPACE(15)),15) + LEFT(( WO.LOT_ID + SPACE(15)),15) + '  ' + WO.PART_ID + '  ' + PA.DESCRIPTION AS GLOSA,  
'' AS ANOTACION,  
GL.DEBIT_AMOUNT AS DEBE,    
GL.CREDIT_AMOUNT AS HABER,    
GD.ID AS BATCH,  
GD.CURRENCY_ID AS MONEDA,  
GD.ENTITY_ID AS ENTIDAD,  
'P' AS ASENTADO  
,'08. WIP - Producción en Proceso' AS TIPO  
,'GJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,GD.ID AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM GJ GD  
INNER JOIN ARG_GJ_LINE AGL ON GD.ID=AGL.GJ_ID AND AGL.AN_SUBDIARIO='WIP'   
INNER JOIN GJ_LINE GL ON GL.GJ_ID=AGL.GJ_ID AND GL.LINE_NO=AGL.LINE_NO  
INNER JOIN WORK_ORDER WO ON AGL.AN_CLAVE = WO.BASE_ID  
INNER JOIN PART PA ON WO.PART_ID = PA.ID  
INNER JOIN ACCOUNT A ON A.ID = GL.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON GD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON AG.MFG_ENTITY_ID = AGL.ENTITY_ID  
  
UNION ALL  
  
SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
GL.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
GD.POSTING_DATE AS FECHA_OPER,  
'W'+CAST(AGL.AN_CLAVE AS VARCHAR (15)) + ' / ' + WO.LOT_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',4)+CAST(GL.LINE_NO AS  VARCHAR(4)),4) AS SUB_CODIGO,
CAST(AGL.AN_CLAVE AS VARCHAR (15)) AS DOC_SUSTENTATORIO,  
'WIP ' + LEFT((WO.BASE_ID + SPACE(15)),15) + LEFT(( WO.LOT_ID + SPACE(15)),15) + '  ' + WO.PART_ID + '  ' + PA.DESCRIPTION AS GLOSA,  
'' AS ANOTACION,  
GL.DEBIT_AMOUNT AS DEBE,    
GL.CREDIT_AMOUNT AS HABER,    
GD.ID AS BATCH,  
GD.CURRENCY_ID AS MONEDA,  
GD.ENTITY_ID AS ENTIDAD,  
'P' AS ASENTADO  
,'08. WIP - Producción en Proceso' AS TIPO  
,'GJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,GD.ID AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM GJ GD  
INNER JOIN ARG_GJ_LINE AGL ON GD.ID=AGL.GJ_ID AND AGL.AN_SUBDIARIO='WIP'   
INNER JOIN GJ_LINE GL ON GL.GJ_ID=AGL.GJ_ID AND GL.LINE_NO=AGL.LINE_NO  
INNER JOIN WORK_ORDER WO ON AGL.AN_CLAVE = WO.BASE_ID  
INNER JOIN CO_PRODUCT CO ON CO.WORKORDER_BASE_ID = WO.BASE_ID  
INNER JOIN PART PA ON CO.PART_ID = PA.ID  
INNER JOIN ACCOUNT A ON A.ID = GL.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON GD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON AG.MFG_ENTITY_ID = AGL.ENTITY_ID  
WHERE WO.PART_ID IS NULL  
  
UNION ALL  
  
SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
GL.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
GD.POSTING_DATE AS FECHA_OPER,  
'W'+CAST(AGL.AN_CLAVE AS VARCHAR (15)) + ' / ' + WO.LOT_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',4)+CAST(GL.LINE_NO AS  VARCHAR(4)),4) AS SUB_CODIGO,
CAST(AGL.AN_CLAVE AS VARCHAR (15)) AS DOC_SUSTENTATORIO,  
'WIP ' + LEFT((WO.BASE_ID + SPACE(15)),15) + LEFT(( WO.LOT_ID + SPACE(15)),15) + '  ' +  '  '  AS GLOSA,  
'' AS ANOTACION,  
GL.DEBIT_AMOUNT AS DEBE,    
GL.CREDIT_AMOUNT AS HABER,    
GD.ID AS BATCH,  
GD.CURRENCY_ID AS MONEDA,  
GD.ENTITY_ID AS ENTIDAD,  
'P' AS ASENTADO  
,'08. WIP - Producción en Proceso' AS TIPO  
,'GJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,GD.ID AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM GJ GD  
INNER JOIN ARG_GJ_LINE AGL ON GD.ID=AGL.GJ_ID AND AGL.AN_SUBDIARIO='WIP'   
INNER JOIN GJ_LINE GL ON GL.GJ_ID=AGL.GJ_ID AND GL.LINE_NO=AGL.LINE_NO  
INNER JOIN WORK_ORDER WO ON AGL.AN_CLAVE = WO.BASE_ID  
LEFT OUTER JOIN CO_PRODUCT CO ON CO.WORKORDER_BASE_ID = WO.BASE_ID  
--INNER JOIN PART PA ON CO.PART_ID = PA.ID  
INNER JOIN ACCOUNT A ON A.ID = GL.GL_ACCOUNT_ID   
INNER JOIN ACCOUNT_PERIOD AP ON GD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON AG.MFG_ENTITY_ID = AGL.ENTITY_ID  
WHERE WO.PART_ID IS NULL AND CO.PART_ID IS NULL  
  
  
UNION ALL  
  
SELECT   
'10' AS LIB,  
AP.ACCT_YEAR AS AÑO,AP.ACCT_PERIOD AS MES,  
AG.COMPANY_NAME AS COMPANY_NAME,  
AG.VAT_REGISTRATION AS RUC,  
GJD.GL_ACCOUNT_ID AS CUENTA,  
A.DESCRIPTION AS DENOMINACION,  
GJD.POSTING_DATE AS FECHA_OPER,  
GJD.GJ_ID AS NRO_CORRELAT,  
'M'+RIGHT(REPLICATE('0',2)+CAST(GJD.DIST_NO AS VARCHAR(2)),2) 
 + RIGHT(REPLICATE('0',2)+CAST(GJD.ENTRY_NO  AS VARCHAR(2)),2) AS SUB_CODIGO,
GJD.GJ_ID AS DOC_SUSTENTATORIO,  
'GJ ' + LEFT((GJD.GJ_ID + SPACE(15)),15) + '  ' + G.DESCRIPTION AS GLOSA,  
'' AS ANOTACION,  
(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END) AS DEBE,    
(CASE WHEN GJD.AMOUNT_TYPE='CR' AND GJD.AMOUNT > 0 THEN GJD.AMOUNT ELSE   
(CASE WHEN GJD.AMOUNT_TYPE='DR' AND GJD.AMOUNT < 0 THEN GJD.AMOUNT * -1 ELSE 0 END)   
END) AS HABER,    
GJD.BATCH_ID AS BATCH,  
GJD.CURRENCY_ID AS MONEDA,  
GJD.ENTITY_ID AS ENTIDAD,  
GJD.POSTING_STATUS AS ASENTADO,  
'08. WIP - Producción en Proceso' AS TIPO  
,'GJ' AS TYPE  
,NULL AS INVOICE_ID  
,NULL AS VOUCHER_ID  
,NULL AS CUSTOMER_ID  
,NULL AS CHECK_ID  
,NULL AS BANK_ACCOUNT_ID  
,NULL AS CONTROL_NO  
,NULL AS ADJUSTMENT_ID  
,G.ID AS GJ_ID  
,NULL AS REVALUE_ID  
,NULL AS PURC_ORDER_ID  
,NULL AS CUST_ORDER_ID  
,NULL AS WORKORDER_TYPE  
,NULL AS WORKORDER_BASE_ID  
,NULL AS WORKORDER_LOT_ID  
,NULL AS WORKORDER_SPLIT_ID  
,NULL AS WORKORDER_SUB_ID  
,NULL AS TRANSACTION_ID  
,NULL AS CODIGO_CLIPROV  
,NULL AS RAZON_SOCIAL_CLIPROV  
FROM GJ_DIST GJD  
INNER JOIN GJ G ON GJD.GJ_ID=G.ID  
INNER JOIN ACCOUNT A ON GJD.GL_ACCOUNT_ID=A.ID   
INNER JOIN ACCOUNT_PERIOD AP ON GJD.POSTING_DATE BETWEEN AP.BEGIN_DATE AND AP.END_DATE  
INNER JOIN APPLICATION_GLOBAL AG ON GJD.ENTITY_ID=AG.MFG_ENTITY_ID  
LEFT OUTER JOIN ARG_GJ AGJ ON G.ID=AGJ.GJ_ID  
WHERE G.ID IN (SELECT DISTINCT GJ_ID FROM ARG_GJ_LINE WHERE AN_SUBDIARIO='WIP')  
AND GJD.GL_ACCOUNT_ID NOT IN (SELECT DISTINCT GL_ACCOUNT_ID FROM GJ_LINE GL   
INNER JOIN ARG_GJ_LINE AGL ON GL.GJ_ID=AGL.GJ_ID AND GL.LINE_NO=AGL.LINE_NO   
WHERE AN_SUBDIARIO='WIP' AND GL.GJ_ID=G.ID)  